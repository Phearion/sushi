name: SUSHI API Deployment

on:
    push:
        tags:
            - 'v*' # Trigger the workflow on tags starting with 'v'

jobs:
    build-and-deploy:
        runs-on: self-hosted

        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Extract tag name
              id: tag_name
              run: echo "TAG_NAME=$(git describe --tags --abbrev=0)" >> $GITHUB_ENV

            - name: Set up Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: '20' # specify your Node.js version

            - name: Install dependencies
              run: npm install

            - name: Execute Gradio Modification
              run: npm run fix:gradio

            - name: Run tests
              run: npm run test

            - name: Build
              run: npm run build

            - name: Deploy private files
              run: sh deployPrivateFiles.sh

            # If tests pass, build and push Docker image
            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v1

            - name: Login to Docker Hub
              uses: docker/login-action@v1
              with:
                  username: ${{ secrets.DOCKER_HUB_USERNAME }}
                  password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

            - name: Build and push Docker image
              uses: docker/build-push-action@v2
              with:
                  context: .
                  file: Dockerfile
                  push: true
                  tags: phanthive/sushi:${{ env.TAG_NAME }}

            - name: Deploy to server
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.PROD_SERVER_IP }}
                  username: ${{ secrets.PROD_SERVER_USER }}
                  key: ${{ secrets.PROD_SERVER_SSH }}
                  port: ${{ secrets.PROD_SERVER_PORT }}
                  script: |
                      docker pull phanthive/sushi:${{ env.TAG_NAME }}
                      docker stop sushi || true
                      docker rm sushi || true
                      docker build --build-arg API_PORT=${{ secrets.API_PORT }} -t phanthive/sushi:${{ env.TAG_NAME }} .
                      docker run -e PORT=${{ secrets.API_PORT }} -d --name sushi -p ${{ secrets.API_PORT }}:${{ secrets.API_PORT }} phanthive/sushi:${{ env.TAG_NAME }}
